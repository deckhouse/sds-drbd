include:
  - project: 'deckhouse/modules/gitlab-ci'
    ref: main
    file: '/templates/Setup.gitlab-ci.yml'
  - project: 'deckhouse/modules/gitlab-ci'
    ref: main
    file: '/templates/Build.gitlab-ci.yml'
  - project: 'deckhouse/modules/gitlab-ci'
    ref: main
    file: '/templates/Deploy.gitlab-ci.yml'

variables:
  MODULES_MODULE_NAME: sds-drbd
  MODULES_REGISTRY: dev-registry.deckhouse.io
  MODULES_MODULE_SOURCE: dev-registry.deckhouse.io/deckhouse/modules
  MODULES_MODULE_TAG: ${CI_COMMIT_REF_NAME}
  MODULES_REGISTRY_LOGIN:  ${MODULES_REGISTRY_LOGIN_DEV}
  MODULES_REGISTRY_PASSWORD:  ${MODULES_REGISTRY_PASSWORD_DEV}


Build:
  extends: .build
  tags:
    - tfprod-distributed-werf

Deploy to Dev:
  extends: .deploy
  variables:
    RELEASE_CHANNEL: dev
  tags:
    - tfprod-distributed-werf

Deploy to DevGeneral:
  extends: .deploy
  variables:
    RELEASE_CHANNEL: dev-general
  tags:
    - tfprod-distributed-werf

Deploy to Alpha:
  extends: .deploy
  variables:
    RELEASE_CHANNEL: alpha
  tags:
    - tfprod-distributed-werf

Deploy to Beta:
  extends: .deploy
  variables:
    RELEASE_CHANNEL: beta
  tags:
    - tfprod-distributed-werf

Deploy to EarlyAccess:
  extends: .deploy
  variables:
    RELEASE_CHANNEL: early-access
  tags:
    - tfprod-distributed-werf

Deploy to Stable:
  extends: .deploy
  variables:
    RELEASE_CHANNEL: stable
  tags:
    - tfprod-distributed-werf

.deploy_prod_registry:
  stage: deploy
  variables:
    MODULES_REGISTRY_PROD: registry-write.deckhouse.io
    MODULES_MODULE_SOURCE_PROD: registry-write.deckhouse.io/deckhouse/ce/modules
    MODULES_MODULE_TAG: ${CI_COMMIT_REF_NAME}
  script:
    - |
      echo "login to registry"
      crane auth -v login ${MODULES_REGISTRY_PROD} -u ${MODULES_REGISTRY_LOGIN_PROD} -p ${MODULES_REGISTRY_PASSWORD_PROD}
      crane auth -v login ${MODULES_REGISTRY} -u ${MODULES_REGISTRY_LOGIN_DEV} -p ${MODULES_REGISTRY_PASSWORD_DEV}

      echo "successfully login to registry"
      REPO_DEV="${MODULES_MODULE_SOURCE}/${MODULES_MODULE_NAME}/release"
      REPO_PROD="${MODULES_MODULE_SOURCE_PROD}/${MODULES_MODULE_NAME}/release"
      
      IMAGE_SRC="${REPO_DEV}:${MODULES_MODULE_TAG}"
      IMAGE_DST_RELEASE="${REPO_PROD}:${RELEASE_CHANNEL}"
      IMAGE_DST_TAG="${REPO_PROD}:${MODULES_MODULE_TAG}"      
      
      echo "✨ Pushing ${IMAGE_SRC} to ${IMAGE_DST_RELEASE}"
      crane copy "${IMAGE_SRC}" "${IMAGE_DST_RELEASE}"
      echo "✨ Pushing ${IMAGE_SRC} to ${IMAGE_DST_TAG}"
      crane copy "${IMAGE_SRC}" "${IMAGE_DST_TAG}"
  only:
    - tags
  except:
    - main
  tags:
    - tfprod-distributed-werf
  when: manual


Deploy to Prod Alpha CE:
  extends: .deploy_prod_registry
  variables:
    RELEASE_CHANNEL: alpha

Deploy to Prod Beta CE:
  extends: .deploy_prod_registry
  variables:
    RELEASE_CHANNEL: beta

Deploy to Prod EA CE:
  extends: .deploy_prod_registry
  variables:
    RELEASE_CHANNEL: earlyaccess

Deploy to Prod Stable CE:
  extends: .deploy_prod_registry
  variables:
    RELEASE_CHANNEL: stable

